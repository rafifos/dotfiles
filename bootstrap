#!/usr/bin/env bash
# shellcheck disable=SC2155,SC1090
#
# References:
# - https://github.com/arcticicestudio/igloo/blob/ac9f7bf7a3e931ff4825757a428e9c00fbb45543/snowblocks/bash/bootstrap
# - https://misc.flogisoft.com/bash/tip_colors_and_formatting
#

##########
# Functions
#
log_info() {
  printf "\e[1;34m[INFO]\e[0m %s\n" "$*"
}

log_warn() {
  printf "\e[1;33m[WARN]\e[0m %s\n" "$*"
}

log_error() {
  printf "\e[1;31m[ERROR]\e[0m %s\n" "$*" 1>&2
}

log_and_sleep() {
  log_info "$1"
  sleep 3
}

warn_elevation() {
  log_warn "This operation requires elevation, you've been warned"
}

pause_and_clear() {
  read -rsp $'Press any key to continue...\n' -n 1
  clear
}

inject_linuxbrew() {
  test -d "$HOME/.linuxbrew" && eval "$("$HOME"/.linuxbrew/bin/brew shellenv)"
  test -d /home/linuxbrew/.linuxbrew && eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
}

##########
# Script entrypoint
#
clear

if ! hash zsh 2>/dev/null; then
  log_and_sleep "Installing zsh"
  warn_elevation
  sudo apt install zsh

  chsh -s "$(command -v zsh)" "$USER"

  log_warn "zsh was installed, please restart your shell and re-run this script"
  exit 0
fi

log_and_sleep "Adding keys to apt"
curl -fsSL 'https://download.docker.com/linux/ubuntu/gpg' | sudo apt-key add -
curl -fsSL 'https://keyserver.ubuntu.com/pks/lookup?op=get&search=0x073e051d7b2aee37' | sudo apt-key add
curl -fsSL 'https://keyserver.ubuntu.com/pks/lookup?op=get&search=0x96b9cd7c22e2c8c5' | sudo apt-key add
pause_and_clear

log_and_sleep "Adding repositories to apt"
echo "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list
echo "deb [arch=amd64] https://ppa.launchpad.net/openrazer/stable/ubuntu $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/openrazer.list
echo "deb [arch=amd64] https://ppa.launchpad.net/polychromatic/stable/ubuntu $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/polychromatic.list
pause_and_clear

log_and_sleep "Updating apt sources"
sudo apt update
pause_and_clear

log_and_sleep "Installing apt packages"
sudo apt install -y build-essential \
                    docker-ce docker-ce-cli containerd.io \
                    network-manager-openvpn-gnome \
                    openrazer-meta polychromatic
pause_and_clear

log_and_sleep "Configuring Docker (adding $USER to the docker group)"
sudo groupadd docker
sudo usermod -aG docker $USER
log_warn "You need to restart your session for the changes to take effect"
pause_and_clear

log_and_sleep "Installing Flatpak packages"
flatpak remote-add --user --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo

curl -fsSLO https://origin.ostree.endlessm.com/keys/eos-flatpak-keyring.gpg
flatpak remote-add --user --gpg-import=eos-flatpak-keyring.gpg eos-apps https://ostree.endlessm.com/ostree/eos-apps
rm eos-flatpak-keyring.gpg

flatpak install --user eos-apps com.google.Chrome
flatpak install --user flathub com.axosoft.GitKraken
flatpak install --user flathub com.getpostman.Postman
flatpak install --user flathub com.slack.Slack
flatpak install --user flathub com.spotify.Client
flatpak install --user flathub com.visualstudio.code
pause_and_clear

inject_linuxbrew
if ! hash brew 2>/dev/null; then
  log_and_sleep "Installing Linuxbrew"

  /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install.sh)"

  inject_linuxbrew
  pause_and_clear
fi

log_and_sleep "Installing cli packages via Linuxbrew Bundle"
brew bundle --verbose
pause_and_clear

log_and_sleep "Installing Node.JS via asdf-vm"
source "$(brew --prefix asdf)/asdf.sh"
asdf plugin add nodejs
bash "$HOME/.asdf/plugins/nodejs/bin/import-release-team-keyring"
pause_and_clear

if [[ ! -x "$(pwd)/homemaker" ]]; then
  log_warn "homemaker not found in current dir, downloading it now."
  curl -s 'https://foosoft.net/projects/homemaker/dl/homemaker_linux_amd64.tar.gz' | tar --extract --gzip
  mv homemaker_linux_amd64/homemaker homemaker
  chmod +x ./homemaker
  rm -rf homemaker_linux_amd64/
fi

log_and_sleep "Deploying dotfiles using homemaker"
./homemaker -clobber -verbose config.toml "$PWD"
pause_and_clear

log_warn "Don't forget to grab Iosevka from https://github.com/be5invis/Iosevka"
