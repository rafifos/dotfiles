#!/usr/bin/env bash
# shellcheck disable=SC2155,SC1090
#
# References:
# - https://github.com/arcticicestudio/igloo/blob/ac9f7bf7a3e931ff4825757a428e9c00fbb45543/snowblocks/bash/bootstrap
# - https://misc.flogisoft.com/bash/tip_colors_and_formatting
#

##########
# Functions
#
log_info() {
  printf "\e[34m[INFO]\e[0m %s\n" "$*"
}

log_warn() {
  printf "\e[33m[WARN]\e[0m %s\n" "$*"
}

log_error() {
  printf "\e[31m[ERROR]\e[0m %s\n" "$*" 1>&2
}

warn_elevation() {
  log_warn "This operation requires elevation, you've been warned"
}

pause_and_clear() {
  read -rsp $'Press any key to continue...\n' -n 1
  clear
}

inject_linuxbrew() {
  test -d "$HOME/.linuxbrew" && eval "$("$HOME"/.linuxbrew/bin/brew shellenv)"
  test -d /home/linuxbrew/.linuxbrew && eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
}

##########
# Script entrypoint
#
clear

if ! hash zsh 2>/dev/null; then
  log_info "Installing zsh"
  warn_elevation
  sudo apt install zsh

  chsh -s "$(command -v zsh)" "$USER"

  log_warn "zsh was installed, please restart your shell and re-run this script"
  exit 0
fi

log_info "Adding keys to apt"
curl -fsSL 'https://packages.microsoft.com/keys/microsoft.asc' | sudo apt-key add -
curl -fsSL 'https://download.docker.com/linux/ubuntu/gpg' | sudo apt-key add -
curl -fsSL 'https://packagecloud.io/shiftkey/desktop/gpgkey' | sudo apt-key add -
curl -fsSL 'https://dl.google.com/linux/linux_signing_key.pub' | sudo apt-key add -
pause_and_clear

log_info "Adding repositories to apt"
echo 'deb [arch=amd64] https://packages.microsoft.com/repos/vscode stable main' | sudo tee /etc/apt/sources.list.d/vscode.list
echo "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list
echo 'deb [arch=amd64] https://packagecloud.io/shiftkey/desktop/any/ any main' | sudo tee /etc/apt/sources.list.d/packagecloud-shiftkey-desktop.list
echo 'deb [arch=amd64] https://dl.google.com/linux/chrome/deb/ stable main' | sudo tee /etc/apt/sources.list.d/google-chrome.list
sudo add-apt-repository 'ppa:openrazer/stable'
sudo add-apt-repository 'ppa:polychromatic/stable'
pause_and_clear

log_info "Updating apt sources"
sleep 2
sudo apt update
pause_and_clear

log_info "Installing apt packages"
sudo apt install build-essential
sudo apt install code
sudo apt install docker-ce docker-ce-cli containerd.io
sudo apt install github-desktop
sudo apt install google-chrome-stable
sudo apt install network-manager-openvpn-gnome
sudo apt install ngrok
sudo apt install openrazer-meta polychromatic
pause_and_clear

log_info "Installing Flathub as a USER repository"
flatpak remote-add --user --if-not-exists 'flathub' 'https://flathub.org/repo/flathub.flatpakrepo'
pause_and_clear

log_info "Installing Flatpak packages"
flatpak install --user flathub 'com.getpostman.Postman'
flatpak install --user flathub 'com.slack.Slack'
flatpak install --user flathub 'com.spotify.Client'
pause_and_clear

inject_linuxbrew
if ! hash brew 2>/dev/null; then
  log_info "Installing Linuxbrew"

  /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install.sh)"

  inject_linuxbrew
  pause_and_clear
fi

log_info "Installing cli packages via Linuxbrew Bundle"
brew bundle --verbose
pause_and_clear

log_info "Installing Node.JS"
source "$(brew --prefix asdf)/asdf.sh"
asdf plugin add nodejs
bash "$HOME/.asdf/plugins/nodejs/bin/import-release-team-keyring"
pause_and_clear

log_info "Deploying dotfiles using homemaker"
if [[ ! -x "$(pwd)/homemaker" ]]; then
  curl -s 'https://foosoft.net/projects/homemaker/dl/homemaker_linux_amd64.tar.gz'  | tar --extract --gzip
  mv homemaker_linux_amd64/homemaker homemaker
  chmod +x ./homemaker
  rm -rf homemaker_linux_amd64/
fi

./homemaker -clobber -verbose config.toml "$PWD"
pause_and_clear
