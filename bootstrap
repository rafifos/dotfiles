#!/usr/bin/env bash
# shellcheck disable=SC2155,SC1090
#
# References:
# - https://github.com/arcticicestudio/igloo/blob/ac9f7bf7a3e931ff4825757a428e9c00fbb45543/snowblocks/bash/bootstrap
# - https://misc.flogisoft.com/bash/tip_colors_and_formatting
#
export BOOTSTRAP_BASE_DIR="$(pwd)"

__bootstrap::log_info() {
  printf "\e[34m[INFO]\e[0m %s\n" "$*"
}

__bootstrap::log_warn() {
  printf "\e[33m[WARN]\e[0m %s\n" "$*"
}

__bootstrap::log_error() {
  printf "\e[31m[ERROR]\e[0m %s\n" "$*" 1>&2
}

__bootstrap::load_core_module() {
  local module
  
  if [ "$#" -eq 0 ]; then
    # shellcheck disable=SC2128
    __bootstrap::log_info "Missing parameter while calling function $FUNCNAME"
    __bootstrap::log_error "Error while loading core modules"
    return 1
  fi

  # shellcheck disable=SC2048
  for module in $*; do
    module="$BOOTSTRAP_BASE_DIR/$module.sh"

    if [[ -f "$module" ]]; then
      if source "$module"; then
        __bootstrap::log_info "Core module $(basename "$module") successfully loaded"
      else
        __bootstrap::log_info "Error while loading core module $(basename "$module")"
      fi
    else
      __bootstrap::log_error "Core module $(basename "$module") not found"
      return 1
    fi
  done
}

# +--------------+
# + Core Modules +
# +--------------+
__bootstrap::load_core_module core/utils core/homemaker core/apt

if [[ "$(__utils::check_command zsh)" -eq 1 ]]; then
  __apt::install zsh

  if [[ "$(__utils::check_command zsh)" -eq 0 ]]; then
    chsh -s "$(command -v zsh)" $USER

    __bootstrap::log_warn "zsh was installed, please restart your shell and re-run this script"
    __utils::pause_and_clear
    exit 0
  else
    __bootstrap::log_error "There was an error installing zsh, exiting"
    exit 1
  fi
fi

__apt::install build-essential git

if [[ "$(__utils::check_command brew)" -eq 1 ]]; then
  __bootstrap::log_info "Installing Linuxbrew"
  __utils::warn_elevation

  /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install.sh)"
  test -d "$HOME/.linuxbrew" && eval "$("$HOME"/.linuxbrew/bin/brew shellenv)"
  test -d /home/linuxbrew/.linuxbrew && eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"

  if [[ "$(__utils::check_command zsh)" -eq 1 ]]; then
    __bootstrap::log_error "There was an error installing Linuxbrew, exiting"
    exit 1
  fi

  __utils::pause_and_clear
fi

__bootstrap::log_info "Installing cli packages via Linuxbrew Bundle"
brew bundle --verbose
__utils::pause_and_clear

__bootstrap::log_info "Installing Docker"
__utils::warn_elevation
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
__apt::add-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"
__apt::install docker-ce docker-ce-cli containerd.io
__utils::pause_and_clear

if [[ ! -x "$(pwd)/homemaker" ]]; then
  __homemaker::install
fi
